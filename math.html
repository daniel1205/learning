<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èªéŸ³å¿ƒç®—ç·´ç¿’</title>
    <style>
        /* CSS æ¨£å¼å€ */
        body {
            font-family: "å¾®è»Ÿæ­£é»‘é«”", "Microsoft JhengHei", sans-serif;
            background-color: #E0F7FA;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            margin: 0;
            min-height: 100vh;
        }

        /* éŠæˆ²ä¸»é¢æ¿ */
        .game-panel {
            background-color: white;
            padding: 30px;
            border-radius: 25px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            text-align: center;
            width: 90%;
            max-width: 500px;
            border: 5px solid #FF9800;
            margin-bottom: 20px;
        }

        h1 {
            color: #009688;
            margin: 10px 0 20px 0;
            font-size: 2.5rem; /* å­—é«”åŠ å¤§ */
            letter-spacing: 2px;
        }

        .score-board {
            background: #FFF3E0;
            padding: 10px 25px;
            border-radius: 50px;
            display: inline-block;
            font-size: 1.8rem;
            color: #E65100;
            font-weight: bold;
            margin-bottom: 20px;
        }

        /* é¡Œç›®é¡¯ç¤ºå€ */
        .question-box-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .question-box {
            font-size: 3.5rem; /* é¡Œç›®æ•¸å­—ç‰¹å¤§ */
            font-weight: bold;
            color: #3F51B5;
            margin: 10px 0;
            padding: 20px;
            background: #EEEEEE;
            border-radius: 15px;
            letter-spacing: 3px;
            flex-grow: 1;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* å–‡å­æŒ‰éˆ• */
        .speaker-btn {
            font-size: 2.5rem;
            background: #E3F2FD;
            border: 2px solid #BBDEFB;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            cursor: pointer;
            padding: 0;
            transition: transform 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .speaker-btn:active { transform: scale(0.9); background: #BBDEFB; }

        /* è¼¸å…¥èˆ‡æ“ä½œå€ */
        .input-area {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 25px;
        }

        input[type="number"] {
            font-size: 2.5rem;
            width: 120px;
            padding: 10px;
            text-align: center;
            border: 3px solid #ccc;
            border-radius: 15px;
        }

        input:focus { border-color: #3F51B5; outline: none; }

        .submit-btn {
            font-size: 1.8rem;
            padding: 10px 30px;
            background-color: #FF5722;
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            box-shadow: 0 5px #bf360c;
        }
        .submit-btn:active {
            box-shadow: 0 2px #bf360c;
            transform: translateY(3px);
        }

        /* æç¤ºè¨Šæ¯ */
        .feedback-msg {
            margin-top: 15px;
            height: 40px;
            font-size: 1.5rem;
            font-weight: bold;
            color: #E65100;
        }

        /* æ­·å²ç´€éŒ„å€ */
        .history-panel {
            width: 90%;
            max-width: 500px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            padding: 20px;
            box-sizing: border-box;
            border: 2px solid #E0E0E0;
        }

        .history-title {
            font-size: 1.5rem;
            color: #555;
            margin-bottom: 10px;
            border-bottom: 2px solid #ddd;
            padding-bottom: 10px;
            font-weight: bold;
        }

        #historyList {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 250px;
            overflow-y: auto;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #eee;
            font-size: 1.4rem;
            color: #333;
        }

        .history-item.correct { background-color: #E8F5E9; color: #2E7D32; }
        .history-item.wrong { background-color: #FFEBEE; color: #C62828; }
        .history-item span { font-weight: bold; }

    </style>
</head>
<body>

    <div class="game-panel">
        <h1>å¿ƒç®—å¤§æŒ‘æˆ°</h1>
        
        <div class="score-board">
            å¾—åˆ†: <span id="score">0</span>
        </div>

        <div class="question-box-wrapper">
            <div class="question-box" id="question">é»æˆ‘é–‹å§‹</div>
            <button class="speaker-btn" onclick="speakCurrentQuestion()" title="å†è½ä¸€æ¬¡">ğŸ”Š</button>
        </div>

        <div class="input-area">
            <input type="number" id="answerInput" placeholder="?" autocomplete="off">
            <button class="submit-btn" onclick="checkAnswer()">é€å‡º</button>
        </div>
        
        <div class="feedback-msg" id="feedback"></div>
    </div>

    <div class="history-panel">
        <div class="history-title">
            ğŸ“ ç·´ç¿’ç´€éŒ„
        </div>
        <ul id="historyList">
            </ul>
    </div>

    <script>
        // è®Šæ•¸è¨­å®š
        let currentN1, currentN2, currentN3, currentOp1, currentOp2, currentAnswer;
        let score = 0;
        let questionTextForSpeech = ""; 
        let gameStarted = false;

        // èªéŸ³åˆæˆç‰©ä»¶
        const synth = window.speechSynthesis;

        // èªªè©±å‡½å¼
        function speak(text) {
            if (synth.speaking) {
                synth.cancel();
            }
            const utterThis = new SpeechSynthesisUtterance(text);
            utterThis.lang = 'zh-TW'; 
            utterThis.rate = 0.85; // èªé€Ÿç¨å¾®æ”¾æ…¢
            utterThis.pitch = 1.1; // èªèª¿ä¸Šæš
            synth.speak(utterThis);
        }

        // ç”¢ç”Ÿé¡Œç›®
        function generateQuestion() {
            let valid = false;
            let n1, n2, n3, op1, op2, result, step1;

            while (!valid) {
                // ç”¢ç”Ÿ 3 çµ„æ•¸å­—
                n1 = Math.floor(Math.random() * 20) + 1;
                n2 = Math.floor(Math.random() * 10) + 1;
                n3 = Math.floor(Math.random() * 10) + 1;
                
                let isPlus1 = Math.random() > 0.5;
                let isPlus2 = Math.random() > 0.5;

                op1 = isPlus1 ? "+" : "-";
                op2 = isPlus2 ? "+" : "-";

                step1 = isPlus1 ? (n1 + n2) : (n1 - n2);
                result = isPlus2 ? (step1 + n3) : (step1 - n3);

                // æ¢ä»¶ï¼šçµæœ 0~30ï¼Œéç¨‹ä¸å‡ºç¾è² æ•¸
                if (result >= 0 && result <= 30 && step1 >= 0) {
                    valid = true;
                    currentN1 = n1; currentN2 = n2; currentN3 = n3;
                    currentOp1 = op1; currentOp2 = op2;
                    currentAnswer = result;
                }
            }

            // æ›´æ–°ç•«é¢æ–‡å­—
            const qText = `${n1} ${op1} ${n2} ${op2} ${n3} = ?`;
            document.getElementById('question').innerText = qText;
            
            // èªéŸ³æ–‡å­—è½‰æ›
            let op1Read = op1 === '+' ? 'åŠ ' : 'æ¸›';
            let op2Read = op2 === '+' ? 'åŠ ' : 'æ¸›';
            questionTextForSpeech = `${n1} ${op1Read} ${n2} ${op2Read} ${n3} ç­‰æ–¼å¤šå°‘ï¼Ÿ`;

            // æœ—è®€é¡Œç›®
            setTimeout(() => speak(questionTextForSpeech), 300);

            // é‡ç½®è¼¸å…¥å€
            document.getElementById('answerInput').value = '';
            document.getElementById('answerInput').focus();
            document.getElementById('feedback').innerText = '';
        }

        function speakCurrentQuestion() {
            if (questionTextForSpeech) {
                speak(questionTextForSpeech);
            } else if (!gameStarted) {
                gameStarted = true;
                generateQuestion();
            }
        }

        // æª¢æŸ¥ç­”æ¡ˆ
        function checkAnswer() {
            if (!gameStarted) {
                gameStarted = true;
                generateQuestion();
                return;
            }

            const input = document.getElementById('answerInput');
            const feedback = document.getElementById('feedback');
            const userVal = parseInt(input.value);

            if (isNaN(userVal)) {
                speak("è«‹å…ˆè¼¸å…¥æ•¸å­—å–”");
                return;
            }

            let isRight = (userVal === currentAnswer);
            let questionStr = `${currentN1} ${currentOp1} ${currentN2} ${currentOp2} ${currentN3}`;

            if (isRight) {
                score += 10;
                document.getElementById('score').innerText = score;
                feedback.innerText = "âœ¨ ç­”å°äº†ï¼";
                feedback.style.color = "#2E7D32"; // ç¶ è‰²
                speak("ç­”å°äº†ï¼å¥½æ£’ï¼");
                
                addToHistory(questionStr, userVal, true);
                
                // 1.5ç§’å¾Œå‡ºä¸‹ä¸€é¡Œ
                setTimeout(generateQuestion, 1500);
            } else {
                feedback.innerText = "âŒ å†è©¦ä¸€æ¬¡";
                feedback.style.color = "#C62828"; // ç´…è‰²
                speak("ä¸å°ï¼Œå†ç®—ç®—çœ‹");
                
                addToHistory(questionStr, userVal, false);

                input.value = '';
                input.focus();
            }
        }

        function addToHistory(qStr, ans, isCorrect) {
            const list = document.getElementById('historyList');
            const li = document.createElement('li');
            li.className = isCorrect ? 'history-item correct' : 'history-item wrong';
            
            const icon = isCorrect ? 'âœ…' : 'âŒ';
            li.innerHTML = `
                <span>${qStr} = ${ans}</span>
                <span>${icon}</span>
            `;
            
            list.insertBefore(li, list.firstChild);
        }

        // æŒ‰ Enter é€å‡º
        document.getElementById('answerInput').addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                checkAnswer();
            }
        });

        // é»æ“Šé¡Œç›®å€ä¹Ÿå¯ä»¥é–‹å§‹
        document.getElementById('question').addEventListener("click", function() {
            if (!gameStarted) {
                gameStarted = true;
                generateQuestion();
            }
        });

    </script>
</body>
</html>
